<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cổng Thông Tin - Trường THCS Ngọc Phụng</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --p: #6366f1; --pd: #4f46e5; --s: #10b981; --a: #f59e0b; --d: #f43f5e;
            --bg: #f8fafc; --sidebar: 280px;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #1e293b; overflow: hidden; }

        /* --- HỆ THỐNG CẤU TRÚC GRID (LAYOUT SYSTEM) --- */
        .app-container { display: grid; grid-template-columns: var(--sidebar) 1fr; height: 100vh; width: 100vw; }
        .sidebar { background: #ffffff; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 100; }
        .viewport { overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; position: relative; }

        /* --- COMPONENT: ULTRA CARD --- */
        .u-card {
            background: #ffffff; border-radius: 28px; border: 1px solid rgba(226, 232, 240, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02), 0 2px 4px -1px rgba(0,0,0,0.01);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .u-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05); }

        /* --- COMPONENT: BUTTONS --- */
        .btn-p { background: var(--p); color: white; padding: 1rem 2rem; border-radius: 18px; font-weight: 800; transition: all 0.2s; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3); }
        .btn-p:hover { background: var(--pd); transform: scale(1.02); }
        .btn-p:active { transform: scale(0.98); }

        /* --- COMPONENT: INPUTS --- */
        .i-premium { width: 100%; padding: 1.2rem; border-radius: 18px; background: #f1f5f9; border: 2px solid transparent; transition: all 0.3s; outline: none; }
        .i-premium:focus { background: white; border-color: var(--p); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        /* --- ANIMATIONS & UTILS --- */
        [x-cloak] { display: none !important; }
        .glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(15px); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 1024px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
        }
    </style>
</head>
<body x-data="eduCore()" x-init="startSystem()">

    <div class="fixed top-6 right-6 z-[9999] space-y-3">
        <template x-for="t in toasts" :key="t.id">
            <div x-show="t.show" x-transition class="bg-white border-l-4 p-5 rounded-2xl shadow-2xl flex items-center gap-4 min-w-[320px]"
                 :class="t.type === 'success' ? 'border-indigo-500' : 'border-rose-500'">
                <div class="w-10 h-10 rounded-full flex items-center justify-center" :class="t.type === 'success' ? 'bg-indigo-50 text-indigo-600' : 'bg-rose-50 text-rose-600'">
                    <i class="fas" :class="t.type === 'success' ? 'fa-check' : 'fa-exclamation'"></i>
                </div>
                <div>
                    <p class="font-black text-slate-800 text-sm" x-text="t.title"></p>
                    <p class="text-xs text-slate-400 font-medium" x-text="t.msg"></p>
                </div>
            </div>
        </template>
    </div>

    <div x-show="!isAuth" class="fixed inset-0 z-[5000] bg-slate-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl rounded-[3.5rem] shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[700px]">
            <div class="md:w-5/12 bg-indigo-600 p-16 text-white flex flex-col justify-between">
                <div>
                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-3xl mb-8"><i class="fas fa-rocket"></i></div>
                    <h1 class="text-5xl font-black leading-tight">Trường THCS<br>Ngọc Phụng</h1>
                    <p class="mt-6 text-indigo-100 opacity-80 leading-relaxed font-medium">Hệ thống quản lý giáo dục chuyên nghiệp với khả năng bảo mật đa tầng và đội ngũ deverloper chuyên nghiệp.</p>
                </div>
                <div class="text-[10px] font-bold uppercase tracking-widest opacity-40">Version 9.5.0 Build 2026</div>
            </div>
            <div class="md:w-7/12 p-12 md:p-20 flex flex-col justify-center">
                <div class="flex p-1.5 bg-slate-100 rounded-2xl mb-10 w-fit">
                    <button @click="authTab = 'login'" :class="authTab === 'login' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'" class="px-8 py-3 rounded-xl font-black text-xs uppercase transition-all">Đăng nhập</button>
                    <button @click="authTab = 'reg'" :class="authTab === 'reg' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'" class="px-8 py-3 rounded-xl font-black text-xs uppercase transition-all">Đăng ký</button>
                </div>

               <div x-show="authTab === 'login'" class="animate__animated animate__fadeIn">
    <h2 class="text-3xl font-black text-slate-800 mb-8">Đăng nhập hệ thống</h2>
    <div class="space-y-5">
        <input x-model="fL.u" type="text" placeholder="Tên đăng nhập" class="i-premium">
        <input x-model="fL.p" type="password" placeholder="Mật khẩu" class="i-premium">
        <button @click="doLogin()" class="w-full btn-p">Bắt đầu làm việc</button>
    </div>
    <div class="mt-8 pt-6 border-t">
        <p class="text-[10px] text-center font-bold uppercase tracking-widest text-slate-400">
            Hệ thống quản trị nội bộ EduSmart
        </p>
    </div>
</div>

                <div x-show="authTab === 'reg'" class="animate__animated animate__fadeIn">
                    <h2 class="text-3xl font-black text-slate-800 mb-6">Tạo tài khoản mới</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <input x-model="fR.name" type="text" placeholder="Họ và tên" class="i-premium col-span-2">
                        <input x-model="fR.u" type="text" placeholder="Tên đăng nhập" class="i-premium">
                        <input x-model="fR.p" type="password" placeholder="Mật khẩu" class="i-premium">
                        <div class="col-span-2 flex gap-4 my-2">
                            <button @click="fR.role = 'student'" :class="fR.role === 'student' ? 'bg-indigo-600 text-white' : 'bg-slate-100'" class="flex-1 p-4 rounded-xl font-bold text-xs">HỌC SINH</button>
                            <button @click="fR.role = 'teacher'" :class="fR.role === 'teacher' ? 'bg-indigo-600 text-white' : 'bg-slate-100'" class="flex-1 p-4 rounded-xl font-bold text-xs">GIÁO VIÊN</button>
                        </div>
                        <template x-if="fR.role === 'teacher'">
                            <input x-model="fR.code" type="text" placeholder="Mã xác thực GV " class="i-premium col-span-2 border-amber-200">
                        </template>
                        <button @click="doRegister()" class="w-full btn-p col-span-2 mt-4">Gửi yêu cầu đăng ký</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="isAuth" x-cloak class="app-container">
        <aside class="sidebar">
            <div class="p-8 mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white"><i class="fas fa-graduation-cap"></i></div>
                    <span class="font-black text-xl tracking-tighter">Tung2k13 Dev</span>
                </div>
            </div>
            <nav class="flex-1 px-4 space-y-2">
                <template x-for="n in navs" :key="n.id">
                    <button x-show="canView(n.perm)" @click="curTab = n.id"
                            :class="curTab === n.id ? 'bg-indigo-600 text-white shadow-xl' : 'text-slate-400 hover:bg-slate-50'"
                            class="w-full flex items-center gap-4 p-4 rounded-2xl font-bold transition-all">
                        <i class="fas w-6" :class="n.icon"></i>
                        <span x-text="n.name"></span>
                    </button>
                </template>
            </nav>
            <div class="p-6 border-t">
                <div class="bg-slate-50 p-4 rounded-2xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-white flex items-center justify-center font-black text-indigo-600" x-text="uInfo?.name[0]"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-black truncate" x-text="uInfo?.name"></p>
                        <p class="text-[9px] font-bold text-indigo-500 uppercase" x-text="uInfo?.role"></p>
                    </div>
                    <button @click="logout()" class="text-slate-300 hover:text-rose-500"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </aside>

        <main class="viewport">
            <header class="glass h-24 px-10 flex justify-between items-center sticky top-0 z-40">
                <h2 class="text-2xl font-black text-slate-800" x-text="navs.find(n=>n.id==curTab).name"></h2>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden md:block">
                        <p class="text-[10px] font-black text-slate-300 uppercase">Hôm nay</p>
                        <p class="text-sm font-black text-slate-600" x-text="dateStr"></p>
                    </div>
                </div>
            </header>

            <div class="p-10 space-y-10">
                <div x-show="curTab === 'news'" class="animate__animated animate__fadeIn">
                    <div x-show="uInfo?.role !== 'student'" class="u-card p-8 mb-10 border-l-4 border-indigo-600">
                        <h3 class="text-xl font-black mb-6 flex items-center gap-2"><i class="fas fa-pen-nib"></i> Soạn bản tin</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <input x-model="fN.t" type="text" placeholder="Tiêu đề..." class="i-premium">
                            <input x-model="fN.y" type="text" placeholder="YouTube ID..." class="i-premium">
                            <textarea x-model="fN.d" placeholder="Nội dung chi tiết..." class="i-premium col-span-2 h-24"></textarea>
                            <div class="col-span-2 flex justify-end">
                                <button @click="postNews()" class="btn-p">Đăng tin ngay</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-8">
                        <template x-for="p in news" :key="p.id">
                            <div class="u-card overflow-hidden">
                                <div class="aspect-video bg-black">
                                    <iframe class="w-full h-full" :src="'https://www.youtube.com/embed/'+p.y" frameborder="0"></iframe>
                                </div>
                                <div class="p-8">
                                    <div class="flex justify-between items-start mb-4">
                                        <span class="text-[10px] font-black text-indigo-600 uppercase" x-text="p.date"></span>
                                        <button x-show="uInfo?.role === 'admin'" @click="del('news', p.id)" class="text-slate-200 hover:text-rose-500"><i class="fas fa-trash"></i></button>
                                    </div>
                                    <h4 class="text-xl font-black text-slate-800 mb-2" x-text="p.t"></h4>
                                    <p class="text-slate-500 text-sm" x-text="p.d"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="curTab === 'sch'" class="animate__animated animate__fadeIn">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h3 class="text-3xl font-black">Thời khóa biểu</h3>
                            <p class="text-slate-400 font-medium">Lịch học trực quan tuần này</p>
                        </div>
                        <button x-show="uInfo?.role !== 'student'" @click="mTarget = 'sch'" class="btn-p">Thêm tiết học</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                        <template x-for="day in days">
                            <div class="space-y-4">
                                <div class="p-4 bg-slate-800 text-white rounded-2xl text-center font-black text-xs uppercase" x-text="day"></div>
                                <div class="min-h-[400px] bg-slate-100/50 rounded-[2rem] p-4 space-y-4 border-2 border-dashed border-slate-200">
                                    <template x-for="s in sch.filter(i=>i.day===day)" :key="s.id">
                                        <div class="u-card p-4 relative group">
                                            <img :src="s.img || 'https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=400'" class="w-full h-24 object-cover rounded-xl mb-3">
                                            <p class="text-[9px] font-black text-indigo-600 uppercase" x-text="s.time"></p>
                                            <p class="font-black text-slate-800 text-sm" x-text="s.sub"></p>
                                            <p class="text-[10px] text-slate-400 font-bold mt-1" x-text="'GV: '+s.tea"></p>
                                            <button x-show="uInfo?.role === 'admin'" @click="del('sch', s.id)" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-rose-500"><i class="fas fa-times-circle"></i></button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="curTab === 'files'" class="animate__animated animate__fadeIn">
                    <div x-show="uInfo?.role !== 'student'" class="u-card p-16 border-4 border-dashed border-indigo-100 flex flex-col items-center text-center">
                        <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-3xl flex items-center justify-center text-3xl mb-6 shadow-inner"><i class="fas fa-upload"></i></div>
                        <h3 class="text-2xl font-black mb-2">Kho học liệu số</h3>
                        <p class="text-slate-400 mb-8 max-w-sm">Tải lên giáo án, bài tập hoặc tài liệu tham khảo (Tối đa 5MB)</p>
                        
                        <input type="file" id="fileInp" class="hidden" @change="uploadFile($event)">
                        <button @click="document.getElementById('fileInp').click()" class="btn-p">
                            Chọn tệp từ thiết bị
                        </button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-5 lg:grid-cols-6 gap-6 mt-12">
                        <template x-for="f in files" :key="f.id">
                            <div class="u-card p-6 text-center relative group">
                                <div class="w-16 h-16 bg-slate-50 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4" :class="f.ext === 'pdf' ? 'text-rose-500' : 'text-blue-500'">
                                    <i class="fas" :class="f.ext === 'pdf' ? 'fa-file-pdf' : 'fa-file-word'"></i>
                                </div>
                                <h5 class="text-[11px] font-black truncate mb-4" x-text="f.name"></h5>
                                <a :href="f.data" :download="f.name" class="block w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-[9px] font-black uppercase">Tải xuống</a>
                                <button x-show="uInfo?.role === 'admin'" @click="del('files', f.id)" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-rose-300 hover:text-rose-500"><i class="fas fa-trash"></i></button>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="curTab === 'admin'" class="animate__animated animate__fadeIn">
                    <div class="u-card overflow-hidden">
                        <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                            <h3 class="text-xl font-black">Quản lý người dùng</h3>
                            <button @click="resetDB()" class="text-[10px] font-black text-rose-500 uppercase border border-rose-100 px-4 py-2 rounded-lg">Xóa sạch dữ liệu</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase">
                                    <tr>
                                        <th class="p-6">Thành viên</th>
                                        <th class="p-6">Tài khoản</th>
                                        <th class="p-6">Vai trò</th>
                                        <th class="p-6 text-right">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="u in users" :key="u.id">
                                        <tr class="border-b last:border-0">
                                            <td class="p-6">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center text-indigo-600 font-black text-xs" x-text="u.name[0]"></div>
                                                    <span class="font-bold text-sm" x-text="u.name"></span>
                                                </div>
                                            </td>
                                            <td class="p-6 font-mono text-xs text-slate-400" x-text="u.u"></td>
                                            <td class="p-6">
                                                <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase" :class="u.role === 'admin' ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-slate-600'" x-text="u.role"></span>
                                            </td>
                                            <td class="p-6 text-right">
                                                <button @click="del('users', u.id)" class="text-rose-400 hover:text-rose-600"><i class="fas fa-user-minus"></i></button>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div x-show="mTarget" x-cloak class="fixed inset-0 z-[6000] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-10 shadow-2xl animate__animated animate__zoomIn">
            <h3 class="text-2xl font-black mb-6">Thêm tiết học mới</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <select x-model="fS.day" class="i-premium"><template x-for="d in days"><option :value="d" x-text="d"></option></template></select>
                    <input x-model="fS.time" type="text" placeholder="Giờ học" class="i-premium">
                </div>
                <input x-model="fS.sub" type="text" placeholder="Tên môn học" class="i-premium">
                <input x-model="fS.tea" type="text" placeholder="Giáo viên" class="i-premium">
                <input x-model="fS.img" type="text" placeholder="Link ảnh minh họa" class="i-premium">
                <div class="flex gap-4 pt-6">
                    <button @click="mTarget = null" class="flex-1 p-4 bg-slate-100 rounded-2xl font-bold">Hủy</button>
                    <button @click="saveSch()" class="flex-1 btn-p">Lưu lại</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function eduCore() {
            return {
                // SYSTEM STATE
                isAuth: false, authTab: 'login', curTab: 'news', mTarget: null,
                uInfo: null, db: null, dateStr: '', toasts: [],
                days: ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6'],
                navs: [
                    { id: 'news', name: 'Bản tin Radio', icon: 'fa-bullhorn', perm: 'all' },
                    { id: 'sch', name: 'Thời khóa biểu', icon: 'fa-calendar-alt', perm: 'all' },
                    { id: 'files', name: 'Kho học liệu', icon: 'fa-cloud', perm: 'all' },
                    { id: 'admin', name: 'Quản trị viên', icon: 'fa-user-shield', perm: 'admin' }
                ],

                // FORM DATA
                fL: { u: '', p: '' },
                fR: { name: '', u: '', p: '', role: 'student', code: '' },
                fN: { t: '', d: '', y: '' },
                fS: { day: 'Thứ 2', time: '', sub: '', tea: '', img: '' },

                // DATABASE STORES
                users: [], news: [], sch: [], files: [],

                // BOOTSTRAP
                async startSystem() {
                    this.dateStr = new Date().toLocaleDateString('vi-VN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    
                    const req = indexedDB.open("EduSmart_v9_5", 1);
                    req.onupgradeneeded = (e) => {
                        const d = e.target.result;
                        ["users", "news", "sch", "files"].forEach(s => d.createObjectStore(s, { keyPath: "id", autoIncrement: true }));
                    };
                    req.onsuccess = async (e) => {
                        this.db = e.target.result;
                        await this.seed();
                        await this.sync();
                    };
                },

                // SEEDING
                async seed() {
                    const u = await this.get('users');
                    if (u.length === 0) {
                        const tx = this.db.transaction(["users", "news"], "readwrite");
                        tx.objectStore("users").add({ name: 'Quản trị viên', u: 'admin', p: '123', role: 'admin' });
                        tx.objectStore("users").add({ name: 'Quản trị viên', u: 'hieutruong', p: '123', role: 'admin' });
                        tx.objectStore("news").add({ t: 'Chào mừng đã đến', d: 'Hệ thống đã sẵn sàng hoạt động.', y: 'Sc6D_T-08gQ', date: '01/01/2026' });
                    }
                },

                // DATABASE HELPERS
                async sync() {
                    this.users = await this.get('users');
                    this.news = (await this.get('news')).reverse();
                    this.sch = await this.get('sch');
                    this.files = await this.get('files');
                },

                get(s) {
                    return new Promise(res => {
                        const t = this.db.transaction(s, "readonly");
                        t.objectStore(s).getAll().onsuccess = (e) => res(e.target.result || []);
                    });
                },

                // AUTH LOGIC
                async doLogin() {
                    const u = this.users.find(i => i.u === this.fL.u && i.p === this.fL.p);
                    if (u) {
                        this.uInfo = u; this.isAuth = true;
                        this.notify("Thành công", `Xin chào ${u.name}`);
                    } else {
                        this.notify("Lỗi", "Tài khoản hoặc mật khẩu sai", "error");
                    }
                },

                async doRegister() {
                    if (!this.fR.name || !this.fR.u || !this.fR.p) return this.notify("Thiếu thông tin", "Vui lòng nhập đủ", "error");
                    if (this.fR.role === 'teacher' && this.fR.code !== 'gvngocphung') return this.notify("Lỗi mã", "Mã xác thực GV sai", "error");
                    if (this.users.some(i => i.u === this.fR.u)) return this.notify("Lỗi", "Tên đăng nhập đã tồn tại", "error");

                    const tx = this.db.transaction("users", "readwrite");
                    await tx.objectStore("users").add({ name: this.fR.name, u: this.fR.u, p: this.fR.p, role: this.fR.role });
                    this.notify("Thành công", "Đã tạo tài khoản, hãy đăng nhập");
                    this.authTab = 'login';
                    await this.sync();
                },

                quickAuth(r) { this.fL.u = r; this.fL.p = '123'; this.doLogin(); },
                logout() { this.isAuth = false; this.uInfo = null; },

                // FEATURE LOGIC
                async postNews() {
                    if (!this.fN.t || !this.fN.y) return;
                    const tx = this.db.transaction("news", "readwrite");
                    await tx.objectStore("news").add({ ...this.fN, date: new Date().toLocaleDateString('vi-VN') });
                    this.fN = { t: '', d: '', y: '' };
                    await this.sync();
                    this.notify("Đã đăng", "Bản tin đã được xuất bản");
                },

                async saveSch() {
                    const tx = this.db.transaction("sch", "readwrite");
                    await tx.objectStore("sch").add({ ...this.fS });
                    this.fS = { day: 'Thứ 2', time: '', sub: '', tea: '', img: '' };
                    this.mTarget = null;
                    await this.sync();
                },

                // FIX: UPLOAD FILE LOGIC
                async uploadFile(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.size > 100 * 1024 * 1024) return this.notify("Lỗi", "File quá 100MB", "error");

                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const tx = this.db.transaction("files", "readwrite");
                        await tx.objectStore("files").add({
                            name: file.name,
                            ext: file.name.split('.').pop().toLowerCase(),
                            data: ev.target.result
                        });
                        await this.sync();
                        this.notify("Đã tải lên", file.name);
                        e.target.value = ''; // Reset input
                    };
                    reader.readAsDataURL(file);
                },

                // UTILS
                async del(s, id) {
                    if (!confirm("Bạn muốn xóa?")) return;
                    const tx = this.db.transaction(s, "readwrite");
                    await tx.objectStore(s).delete(id);
                    await this.sync();
                },

                canView(p) { return p === 'all' || this.uInfo?.role === p; },
                
                notify(title, msg, type = 'success') {
                    const id = Date.now();
                    this.toasts.push({ id, title, msg, type, show: true });
                    setTimeout(() => {
                        const idx = this.toasts.findIndex(i => i.id === id);
                        if (idx !== -1) this.toasts[idx].show = false;
                    }, 3000);
                },

                async resetDB() {
                    if (!confirm("Xóa toàn bộ dữ liệu hệ thống?")) return;
                    const dbs = ["users", "news", "sch", "files"];
                    const tx = this.db.transaction(dbs, "readwrite");
                    dbs.forEach(s => tx.objectStore(s).clear());
                    location.reload();
                }
            }
        }
    </script>
</body>
</html>
